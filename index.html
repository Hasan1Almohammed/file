<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>رفع ومشاركة ملفات</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
* { box-sizing: border-box; margin:0; padding:0; }
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    padding: 20px;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

/* العناوين */
h2 { margin-bottom: 15px; text-align:center; }

/* الملفات */
#files { margin-top:20px; display:flex; flex-direction:column; gap:12px; }
.file {
    padding:15px;
    border-radius:12px;
    box-shadow:0 4px 10px rgba(0,0,0,0.2);
    background:#fff;
}
.file b { word-break: break-word; }

/* الأزرار */
button {
    padding: 10px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-weight:bold;
}
.btn-upload { background:#2196f3; color:#fff; }
.btn-copy { background:#4caf50; color:#fff; }
.btn-delete { background:#f44336; color:#fff; }

/* أزرار الملفات */
.file-actions {
    display:flex;
    gap:10px;
    flex-wrap:wrap;
}

/* progress */
progress {
    width:100%;
    height:12px;
    margin-top:8px;
    display:none;
}

/* الهاتف فقط */
@media(max-width:600px){
    button {
        width:100%;
    }
    .file-actions {
        flex-direction:column;
    }
}
footer {
    margin-top: 20px;
    text-align:center;
    font-size:14px;
    opacity:0.7;
}
</style>
</head>
<body>

<h2>رفع ملف</h2>
<input type="file" id="fileInput">
<button class="btn-upload" onclick="uploadFile()">رفع الملف</button>
<progress id="uploadProgress" value="0" max="100"></progress>

<hr>

<h2>الملفات</h2>
<div id="files"></div>

<footer>
Developer by Hasan | © 2026
</footer>

<script>
const supabaseClient = supabase.createClient(
 "https://tlmkjawlfszsxtdszvol.supabase.co",
 "sb_publishable_qYUNJQIlY_w12AXUwSAW_Q_l89ThqTB"
);

// رفع مع progress
async function uploadFile() {
    const file = document.getElementById("fileInput").files[0];
    if(!file) return alert("اختر ملف");
    if(file.size > 50*1024*1024) return alert("الحد الأقصى 50MB");

    const bar = document.getElementById("uploadProgress");
    bar.style.display = "block";
    bar.value = 0;

    const name = crypto.randomUUID()+"_"+file.name;

    await supabaseClient.storage.from("uploads")
        .upload(name, file, {
            onUploadProgress: p => {
                bar.value = Math.round((p.loaded / p.total) * 100);
            }
        });

    bar.style.display = "none";
    loadFiles();
}

// عرض الملفات
async function loadFiles() {
    const { data } = await supabaseClient.storage.from("uploads").list("");
    const box = document.getElementById("files");
    box.innerHTML = "";

    data.forEach(f => {
        const url = supabaseClient.storage
            .from("uploads")
            .getPublicUrl(f.name).data.publicUrl;

        box.innerHTML += `
        <div class="file">
            <b>${f.name}</b>
            <div class="file-actions">
                <button class="btn-copy" onclick="download('${url}','${f.name}',this)">تنزيل</button>
                <button class="btn-delete" onclick="deleteFile('${f.name}')">حذف</button>
            </div>
            <progress max="100"></progress>
        </div>`;
    });
}

// تنزيل مع progress
async function download(url, name, btn){
    const progress = btn.parentElement.nextElementSibling;
    progress.style.display = "block";
    progress.value = 0;

    const res = await fetch(url);
    const reader = res.body.getReader();
    const contentLength = +res.headers.get('Content-Length');
    let received = 0;
    const chunks = [];

    while(true){
        const {done, value} = await reader.read();
        if(done) break;
        chunks.push(value);
        received += value.length;
        progress.value = Math.round((received / contentLength) * 100);
    }

    const blob = new Blob(chunks);
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
    URL.revokeObjectURL(a.href);

    progress.style.display = "none";
}

// حذف
async function deleteFile(name){
    if(!confirm("هل أنت متأكد من الحذف؟")) return;
    await supabaseClient.storage.from("uploads").remove([name]);
    loadFiles();
}

loadFiles();
</script>

</body>
</html>
